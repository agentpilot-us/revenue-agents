// Prisma Schema – simplified per cleanup plan

generator client {
  provider = "prisma-client-js"
}

// In Prisma 7+, connection URL is set in prisma.config.ts
datasource db {
  provider = "postgresql"
}

// ----- NextAuth (do not change) -----
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts   Account[]
  sessions   Session[]
  companies  Company[]
  activities Activity[]
  messagingFrameworks MessagingFramework[]
  orgs             Org[]
  products         Product[]
  contentLibraries ContentLibrary[]
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires   DateTime
  @@unique([identifier, token])
}

// ----- Business: Company (Account in spec; name kept to avoid NextAuth Account clash) -----
model Company {
  id          String   @id @default(cuid())
  name        String
  domain      String?
  industry    String?
  website     String?
  size        String?  // "1-50", "51-200", etc.

  userId      String
  user        User     @relation(fields: [userId], references: [id])

  contacts        Contact[]
  activities      Activity[]
  departments     CompanyDepartment[]
  companyProducts CompanyProduct[]
  expansionPlays  ExpansionPlay[]
  stakeholderEngagementPlays StakeholderEngagementPlay[]
  useCaseExplorationPlays UseCaseExplorationPlay[]
  renewalPlays    RenewalPlay[]

  lastFitCalculation DateTime? // When product fit was last calculated
  fitCalculationData Json?     // Cached product fit results (opportunities array) for quick retrieval

  accountMessaging AccountMessaging?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([industry])
}

// Account-level messaging: why this company, use cases, success stories, objection handlers, do-not-mention
model AccountMessaging {
  id        String   @id @default(cuid())
  companyId String   @unique
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  userId    String

  whyThisCompany   Json?   // array of strings (bullet points)
  useCases         Json?   // array of { contentLibraryId: string, customNote?: string, departmentFit: string[] }
  successStories   Json?   // array of { contentLibraryId: string, whyRelevant: string, bestForDepartments: string[] }
  objectionHandlers Json? // array of { objection: string, response: string }
  doNotMention     Json?   // array of { topic: string, reason: string }
  aiGenerated      Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([userId])
}

// ----- Contact with engagement -----
model Contact {
  id String @id @default(cuid())

  firstName   String?
  lastName    String?
  email       String?
  phone       String?
  title       String?
  department  String?   // Legacy free-text; use companyDepartmentId for structured department
  companyDepartmentId String?
  companyDepartment   CompanyDepartment? @relation(fields: [companyDepartmentId], references: [id], onDelete: SetNull)
  personaId   String?
  persona     Persona? @relation(fields: [personaId], references: [id], onDelete: SetNull)
  linkedinUrl String?
  photoUrl    String?
  bio         String?  @db.Text
  enrichedData Json?

  city    String?
  state   String?
  country String?

  seniority      String?
  seniorityLevel Int?

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  lastContactedAt    DateTime?
  lastContactMethod  String?
  lastEmailSentAt    DateTime?
  lastEmailOpenedAt  DateTime?
  lastEmailClickedAt DateTime?
  lastEmailRepliedAt DateTime?

  totalEmailsSent    Int @default(0)
  totalEmailsOpened  Int @default(0)
  totalEmailsClicked Int @default(0)
  totalEmailsReplied Int @default(0)

  engagementScore Float?
  isResponsive    Boolean @default(false)
  isDormant       Boolean @default(false)

  activities       Activity[]
  eventAttendances EventAttendance[]
  stakeholderEngagementPlays StakeholderEngagementPlay[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([email, companyId])
  @@index([companyId])
  @@index([department])
  @@index([companyDepartmentId])
  @@index([personaId])
  @@index([lastContactedAt])
  @@index([lastEmailRepliedAt])
  @@index([engagementScore])
  @@index([seniorityLevel])
  @@index([city, state])
}

model Activity {
  id        String   @id @default(cuid())
  type      String   // EMAIL_SENT, MEETING_SCHEDULED, etc. (see ActivityType enum for canonical values)
  summary   String
  content   String?  @db.Text
  subject   String?
  body      String?  @db.Text
  metadata  Json?

  companyId      String
  company        Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyDepartmentId String?
  companyDepartment   CompanyDepartment? @relation(fields: [companyDepartmentId], references: [id], onDelete: SetNull)
  contactId String?
  contact   Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  userId    String
  user      User     @relation(fields: [userId], references: [id])

  resendEmailId String?
  calEventId    String?
  agentUsed     String?

  createdAt DateTime @default(now())

  @@index([companyId])
  @@index([companyDepartmentId])
  @@index([contactId])
  @@index([type])
  @@index([resendEmailId])
  @@index([createdAt])
}

model EventAttendance {
  id         String   @id @default(cuid())
  contactId  String
  contact    Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  eventName  String
  eventDate  DateTime
  source     String
  rsvpStatus String?
  createdAt  DateTime @default(now())
  @@unique([contactId, eventName])
  @@index([eventName])
  @@index([eventDate])
}

model MessagingFramework {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  @@index([userId])
}

// ============================================
// ACCOUNT & DEPARTMENT HIERARCHY (Org = account level)
// Org = business account (spec "Account"; name avoids NextAuth Account clash)
// ============================================

model Org {
  id          String   @id @default(cuid())
  userId      String
  name        String
  industry    String
  website     String?
  description String?  @db.Text

  orgDepartments OrgDepartment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([industry])
}

model OrgDepartment {
  id          String   @id @default(cuid())
  accountId   String
  account     Org      @relation(fields: [accountId], references: [id], onDelete: Cascade)
  name        String
  description String?  @db.Text

  relevantProducts DepartmentProduct[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([accountId])
}

// ============================================
// DEPARTMENT LAYER (Company-scoped)
// ============================================

enum DepartmentType {
  SALES
  MARKETING
  CUSTOMER_SUCCESS
  REVENUE_OPERATIONS
  PRODUCT
  ENGINEERING
  AUTONOMOUS_VEHICLES
  MANUFACTURING_OPERATIONS
  INDUSTRIAL_DESIGN
  IT_DATA_CENTER
  SUPPLY_CHAIN
  CONNECTED_SERVICES
  EXECUTIVE_LEADERSHIP
  FINANCE
  LEGAL
  HR
  OTHER
}

enum DepartmentStatus {
  ACTIVE_CUSTOMER
  EXPANSION_TARGET
  RESEARCH_PHASE
  NOT_ENGAGED
  NOT_APPLICABLE
}

model CompanyDepartment {
  id                String            @id @default(cuid())

  companyId         String
  company           Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)

  type              DepartmentType
  customName        String?
  status            DepartmentStatus  @default(NOT_ENGAGED)

  estimatedSize     Int?
  budget            Decimal?          @db.Decimal(18, 2)
  notes             String?           @db.Text

  contacts          Contact[]
  companyProducts   CompanyProduct[]
  activities        Activity[]
  expansionPlays    ExpansionPlay[]
  useCaseExplorationPlays UseCaseExplorationPlay[]

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@unique([companyId, type])
  @@index([companyId])
  @@index([status])
}

// ============================================
// PRODUCT CATALOG (Company × Product × Department matrix)
// ============================================

enum ProductOwnershipStatus {
  ACTIVE
  TRIAL
  CHURNED
  OPPORTUNITY
  NOT_APPLICABLE
}

model CatalogProduct {
  id                String            @id @default(cuid())

  name              String            @unique
  slug              String            @unique
  description       String?           @db.Text

  priceMin          Decimal?          @db.Decimal(18, 2)
  priceMax          Decimal?          @db.Decimal(18, 2)
  pricingModel      String?

  targetDepartments DepartmentType[]
  targetPersonas    String[]

  useCases          String[]
  contentTags       String[]

  companyProducts   CompanyProduct[]
  expansionPlays    ExpansionPlay[]

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([slug])
}

model CompanyProduct {
  id                String                  @id @default(cuid())

  companyId         String
  company           Company                 @relation(fields: [companyId], references: [id], onDelete: Cascade)

  companyDepartmentId String?
  companyDepartment   CompanyDepartment?    @relation(fields: [companyDepartmentId], references: [id], onDelete: SetNull)

  productId         String
  product           CatalogProduct          @relation(fields: [productId], references: [id])

  status            ProductOwnershipStatus  @default(OPPORTUNITY)
  arr               Decimal?                @db.Decimal(18, 2)
  contractStart     DateTime?
  contractEnd       DateTime?

  fitScore          Decimal?                @db.Decimal(5, 2)
  fitReasoning      String?                 @db.Text
  opportunitySize   Decimal?                @db.Decimal(18, 2)

  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt

  @@unique([companyId, companyDepartmentId, productId])
  @@index([companyId])
  @@index([companyDepartmentId])
  @@index([productId])
  @@index([status])
}

// ============================================
// ACTIVE PLAYS (expansion play tracking)
// ============================================

enum PlayStatus {
  RESEARCH_PHASE
  OUTREACH
  FOLLOW_UP_NEEDED
  DEMO_SCHEDULED
  DISCOVERY_BOOKED
  NEGOTIATION
  WON
  LOST
}

model ExpansionPlay {
  id                    String            @id @default(cuid())

  companyId             String
  company               Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyDepartmentId   String
  companyDepartment     CompanyDepartment  @relation(fields: [companyDepartmentId], references: [id], onDelete: Cascade)
  productId             String
  product               CatalogProduct    @relation(fields: [productId], references: [id], onDelete: Cascade)

  status                PlayStatus        @default(RESEARCH_PHASE)
  weekNumber            Int               @default(1)
  totalWeeks            Int                @default(12)
  lastActionSummary     String?           @db.Text
  lastActionAt          DateTime?
  nextActionSummary     String?           @db.Text
  nextActionDue         DateTime?
  opportunitySize       Decimal?          @db.Decimal(18, 2)

  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  @@unique([companyId, companyDepartmentId, productId])
  @@index([companyId])
  @@index([companyDepartmentId])
  @@index([status])
}

// New Stakeholder Engagement play run (trigger: new VP/Director/C-level at tracked account)
model StakeholderEngagementPlay {
  id                   String    @id @default(cuid())
  companyId            String
  company              Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contactId            String
  contact              Contact   @relation(fields: [contactId], references: [id], onDelete: Cascade)

  currentStep          Int       @default(1)  // 1-5
  status               String    @default("active")  // active | paused | completed
  playState            String    @default("waiting_for_user")  // running | waiting_for_user | waiting_for_time | paused | completed | cancelled
  stepState            Json?     // { "1": "completed", "2": "needs_review" | "user_task" | "completed", ... }
  researchProgress     Json?     // optional: { phase, steps, percent } for research-running UX
  messages             Json?     // play-scoped chat: [{ role, content, createdAt }]
  draftAttachment      String?   // e.g. content library label for display

  researchData         Json?     // Step 1: structured { summary, background, recentActivity, warmIntroPaths, talkingPoints, ... }
  draftEmail           Json?     // Step 2: { subject, body }
  draftEmailApproved   Boolean?  // Step 2: null = pending, true = approved, false = rejected
  stepCompletedAt      Json?     // { "1": "ISO date", "2": "ISO date", ... }

  createdAt            DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([companyId])
  @@index([contactId])
  @@index([status])
}

// Use Case Exploration: per-department find contacts, send emails, invite to events
model UseCaseExplorationPlay {
  id                   String    @id @default(cuid())
  companyId            String
  company              Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyDepartmentId  String
  companyDepartment    CompanyDepartment @relation(fields: [companyDepartmentId], references: [id], onDelete: Cascade)

  currentStep          Int       @default(1)   // 1-4
  playState            String    @default("waiting_for_user")  // running | waiting_for_user | paused | completed | cancelled
  stepState            Json?     // { "1": "completed", "2": "user_task", ... }
  stepCompletedAt      Json?     // { "1": "ISO date", ... }

  targetContactIds     Json?     // [{ contactId, addedAt }]
  drafts               Json?     // [{ contactId, subject, body, sentAt? }]
  eventIntent          Json?     // { eventType?, eventId?, contactIds? }

  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  @@index([companyId])
  @@index([companyDepartmentId])
  @@index([playState])
}

// Proactive Renewal Audit (90-day trigger)
model RenewalPlay {
  id                String   @id @default(cuid())
  companyId         String
  company           Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  renewalDate       DateTime

  currentStep       Int      @default(1)  // 1-5
  status            String   @default("active")  // active | paused | completed

  healthCheckData   Json?    // Step 1: health score, signals
  roiReport         Json?    // Step 2: ROI report content
  stepCompletedAt   Json?    // { "1": "ISO date", ... }

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([companyId])
  @@index([renewalDate])
  @@index([status])
}

model Product {
  id          String   @id @default(cuid())
  userId      String
  name        String
  description String?  @db.Text
  category    String?

  contentLibrary     ContentLibrary[]
  departmentProducts DepartmentProduct[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model DepartmentProduct {
  id           String  @id @default(cuid())
  departmentId String
  productId    String
  relevance    String? @db.Text
  priority     Int     @default(5)

  department OrgDepartment @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  product    Product       @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([departmentId, productId])
  @@index([departmentId])
  @@index([productId])
}

enum ContentType {
  Framework
  UseCase
  SuccessStory
  Persona
  Battlecard
}

model ContentLibrary {
  id        String      @id @default(cuid())
  userId    String
  productId String

  title   String
  type    ContentType
  content Json

  persona    String?
  department String?
  industry   String?
  company    String?
  competitor String?

  inferredTags    Json?
  userConfirmed   Boolean @default(false)
  confidenceScore String?

  sourceUrl String?
  scrapedAt DateTime?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([userId, type])
  @@index([productId, persona])
  @@index([productId, department])
  @@index([productId, industry])
  @@index([company])
  @@index([confidenceScore])
}

// ============================================
// PERSONAS (department + role matrix)
// ============================================

model Persona {
  id                    String            @id @default(cuid())

  name                  String            @unique
  description           String?           @db.Text

  includeTitles         String[]
  excludeTitles         String[]

  primaryDepartment    DepartmentType?
  secondaryDepartments  DepartmentType[]

  painPoints            String[]
  successMetrics        String[]

  contentTypes          String[]
  messagingTone         String            @default("business")

  preferredChannels     String[]

  contacts              Contact[]

  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  @@index([primaryDepartment])
}

// ============================================
// CONTENT ITEMS (AI-tagged content library)
// ============================================

enum ContentItemType {
  CASE_STUDY
  WHITEPAPER
  ROI_CALCULATOR
  DEMO_VIDEO
  PRODUCT_BRIEF
  BATTLECARD
  EMAIL_TEMPLATE
  PRESENTATION
  RESEARCH_REPORT
  USE_CASE_GUIDE
}

model ContentItem {
  id          String          @id @default(cuid())

  title       String
  description String?         @db.Text
  type        ContentItemType
  url         String?
  fileUrl     String?

  industries  Json?
  departments Json?
  personas    Json?
  useCases    Json?
  stage       String?

  fullText    String?         @db.Text

  tags        String[]

  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([type])
}
